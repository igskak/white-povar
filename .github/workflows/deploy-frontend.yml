name: Deploy Frontend to Firebase

on:
  push:
    branches: [main]
    paths: ['frontend/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Dart SDK 3.5.4
        uses: dart-lang/setup-dart@v1.6.5
        with:
          sdk: '3.5.4'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Verify Dart version
        run: dart --version
          
      - name: Install dependencies
        run: |
          cd frontend
          flutter pub get
          
      - name: Build web app
        run: |
          cd frontend
          flutter build web --release --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }} --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: live
          entryPoint: './frontend'
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
